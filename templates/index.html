<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TEDA ‚Äî DA Benchmarking (Lorenz-96)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#5b6776;
      --text:#0f172a;
      --border:#e6eaf0;
      --shadow: 0 10px 26px rgba(15, 23, 42, 0.10);

      --pill:#eef2ff;
      --pillText:#1e3a8a;

      --accent:#2563eb;
      --accent2:#7c3aed;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --soft:#fbfcff;

      /* new: light ‚Äúselected‚Äù method-chip color (NOT like Run button) */
      --methodSelBg:#eaf2ff;         /* light blue */
      --methodSelBorder:#bfdbfe;     /* blue-200 */
      --methodSelText:#1e40af;       /* blue-800 */
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.10), transparent 55%),
                  radial-gradient(900px 500px at 80% -20%, rgba(124,58,237,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .wrap{ width: min(1600px, calc(100vw - 36px)); margin: 0 auto; padding: 18px 18px 70px; }

    /* ---------- Top chips ---------- */
    .topbar{ display:flex; justify-content:center; padding: 10px 0 6px; margin-bottom: 10px; }
    .topActions{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content: center; }

    .topChip{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 10px 12px; border-radius: 999px; border: 0;
      cursor:pointer; user-select:none;
      font-weight: 900; font-size: 13px; color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 26px rgba(37,99,235,.22);
      text-decoration:none;
    }
    .topChip:hover{ transform: translateY(-1px); }
    .topChip:active{ transform: translateY(0px); }

    .hero{ display:flex; flex-direction:column; align-items:center; gap: 10px; text-align:center; margin: 6px 0 14px; }
    .brandMark{ display:flex; flex-direction:column; align-items:center; gap: 12px; }
    .brandMark img{
      width: 500px; height: 200px; border-radius: 28px;
      box-shadow: var(--shadow);
      background: #fff; object-fit: contain;
      border: 1px solid rgba(230,234,240,.95);
    }
    .brandMark h1{ margin: 0; font-size: 24px; letter-spacing: .2px; }
    .brandMark p{ margin: 0; color: var(--muted); font-size: 13px; line-height: 1.4; max-width: 1040px; }

    .stack{ display:flex; flex-direction:column; gap: 14px; }

    .card{
      background: rgba(255,255,255,.86);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(6px);
    }

    .card h3{ margin: 0 0 10px; font-size: 13px; color: #111827; letter-spacing:.2px; }
    .muted{ color: var(--muted); font-size: 12px; }

    label{ display:block; margin-top: 10px; font-size: 12px; color: var(--muted); }
    input, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      outline: none;
      background: #fff;
      margin-top: 6px;
      font-size: 13px;
    }

    .row6{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      align-items:end;
      margin-top: 10px;
    }

    .chipbar{ display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }

    /* ========= METHOD CHIPS (selector) =========
       - Unselected: clean light
       - Selected (has >=1 instance): light blue (NOT gradient)
    */
    .methodChip{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      font-size: 12px;
      color: #0f172a;
      font-weight: 900;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .methodChip:hover{ transform: translateY(-1px); }
    .methodChip:active{ transform: translateY(0px); }
    .methodChip .dot{ width:8px; height:8px; border-radius: 50%; background: rgba(15,23,42,.25); }

    .methodChip.selected{
      border: 1px solid var(--methodSelBorder);
      color: var(--methodSelText);
      background: var(--methodSelBg);
      box-shadow: 0 10px 18px rgba(37,99,235,.10);
    }
    .methodChip.selected .dot{ background: rgba(37,99,235,.85); }

    .chipCount{
      margin-left: 2px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      color: rgba(15,23,42,.75);
    }
    .methodChip.selected .chipCount{
      border: 1px solid rgba(30,64,175,.25);
      background: rgba(37,99,235,.10);
      color: var(--methodSelText);
    }

    /* status dots */
    .dot.ok{ background: var(--ok) !important; }
    .dot.warn{ background: var(--warn) !important; }
    .dot.bad{ background: var(--bad) !important; }

    .methodTablets{ margin-top: 12px; display:flex; flex-direction:column; gap: 10px; }
    .tablet{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .tabletHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,1));
    }
    .tabletLeft{ display:flex; align-items:center; gap: 10px; min-width:0; }
    .tabletTitle{ display:flex; flex-direction:column; gap: 2px; min-width:0; }
    .tabletTitle strong{ font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tabletTitle span{ font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tabletRight{ display:flex; align-items:center; gap: 8px; color: var(--muted); font-size: 12px; white-space:nowrap; }

    .miniBtn{
      border: 1px solid var(--border);
      background: #fff;
      padding: 7px 9px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(15,23,42,.05);
      font-size: 12px;
      color:#0f172a;
      font-weight: 800;
    }
    .miniBtn:hover{ transform: translateY(-1px); }
    .miniBtn:disabled{ opacity: .45; cursor: not-allowed; transform:none; }

    .tabletBody{
      border-top: 1px solid var(--border);
      padding: 12px 12px;
      display:none;             /* collapsed by default */
      background: #fff;
    }
    .tabletBody.open{ display:block; }

    .paramGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }
    .paramField label{ margin-top: 0; }
    .paramField input, .paramField select{ margin-top: 6px; }

    .hint{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px dashed #dbe4ff;
      background: #f5f8ff;
      color: #1f3a8a;
      font-size: 12px;
      line-height: 1.35;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .hintLeft{ flex: 1 1 520px; min-width: 260px; }
    .hintRight{ flex: 0 0 auto; display:flex; align-items:center; gap: 8px; }
    .selectedPill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      font-weight: 900;
      box-shadow: 0 14px 26px rgba(37,99,235,.18);
      white-space: nowrap;
      user-select:none;
      font-size: 12px;
    }

    .actionsRow{ display:flex; align-items:center; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .btn{
      flex: 1 1 220px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 0;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 14px 26px rgba(37,99,235,.22);
    }
    .btn:active{ transform: translateY(1px); }

    .secondaryBtn{
      flex: 0 0 auto;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.88);
      padding: 12px 12px;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      font-weight: 900;
      font-size: 13px;
      color:#0f172a;
    }
    .secondaryBtn:hover{ transform: translateY(-1px); }
    .secondaryBtn:active{ transform: translateY(0px); }

    .runs{ display:flex; flex-direction:column; gap: 12px; }
    .runCard{
      background: rgba(255,255,255,.88);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .runHead{
      display:flex; justify-content:space-between; align-items:center;
      padding: 14px 14px;
      cursor: pointer;
      gap: 12px;
    }
    .runTitle{ display:flex; flex-direction:column; gap: 4px; min-width:0; }
    .runTitle strong{ font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .runTitle span{ font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .runHead .right{ display:flex; align-items:center; gap: 10px; color: var(--muted); font-size: 12px; white-space:nowrap; }

    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
      color:#0f172a;
      font-weight: 900;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .pill.ok{ color: var(--ok); border-color: rgba(22,163,74,.25); }
    .pill.bad{ color: var(--bad); border-color: rgba(220,38,38,.25); }
    .pill.warn{ color: var(--warn); border-color: rgba(245,158,11,.25); }

    .spinner{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(15,23,42,.20);
      border-top-color: rgba(37,99,235,.95);
      animation: spin 0.85s linear infinite;
      display:inline-block;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .checkIcon{
      width: 14px;
      height: 14px;
      border-radius: 4px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      line-height: 1;
      color: #fff;
      background: var(--ok);
      font-weight: 900;
    }

    .runBody{
      border-top: 1px solid var(--border);
      padding: 14px;
      display:none;
      background: rgba(255,255,255,.9);
    }
    .runBody.open{ display:block; }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .toggle{ display:flex; gap: 8px; align-items:center; color: var(--muted); font-size: 12px; }
    .toggle button{
      border: 1px solid var(--border);
      background: #fff;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 0 6px 14px rgba(15,23,42,.05);
      font-weight: 900;
    }
    .toggle button.active{ background: var(--pill); border-color:#c7d2fe; color: var(--pillText); }

    /* run chips (keep subtle) */
    .runChip{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #c7d2fe;
      cursor: default;
      user-select:none;
      font-size: 12px;
      color: var(--pillText);
      font-weight: 900;
      background: var(--pill);
      box-shadow: 0 6px 16px rgba(15,23,42,.05);
    }

    /* Sections inside run body */
    .section{
      margin-top: 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
      overflow:hidden;
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,1));
    }
    .sectionHead strong{ font-size: 12px; letter-spacing:.2px; }
    .sectionBody{
      border-top: 1px solid var(--border);
      padding: 12px;
      display:none;
      background: var(--soft);
    }
    .sectionBody.open{ display:block; }
    .sectionRight{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    /* charts inside sections */
    .chartWrap{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
    }

    /* summary grid (side-by-side) */
    .summaryGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .summaryTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 0;
      font-size: 12px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
    }
    thead{ background: #f8fafc; }
    th, td{
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      text-align:left;
      color:#0f172a;
      vertical-align: top;
    }
    th{ color: var(--muted); font-weight: 900; font-size: 11px; letter-spacing:.3px; }
    td small{ color: var(--muted); }

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalBackdrop.open{ display:flex; }
    .modal{
      width: min(980px, 100%);
      background: #fff;
      border-radius: 22px;
      border: 1px solid rgba(230,234,240,.9);
      box-shadow: 0 24px 70px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.10));
      border-bottom: 1px solid rgba(230,234,240,.9);
    }
    .modalHead strong{ font-size: 14px; }
    .modalBody{
      padding: 14px;
      max-height: min(70vh, 820px);
      overflow:auto;
    }

    .helpGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .helpCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
    }
    .helpCard strong{ font-size: 13px; }
    .helpCard p{ margin: 6px 0 0; color: var(--muted); font-size: 12px; line-height: 1.35; }

    .citeIntro{ color: var(--muted); font-size: 12px; line-height: 1.35; margin-bottom: 10px; }
    .citeList{
      margin: 0;
      padding-left: 18px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 12px;
      line-height: 1.45;
    }
    .citeList a{ color: #1d4ed8; font-weight: 900; text-decoration: none; }
    .citeList a:hover{ text-decoration: underline; }

    .resourceCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
    }
    .resourceCard h4{ margin:0; font-size: 14px; letter-spacing:.1px; }
    .resourceCard p{ margin: 8px 0 0; color: var(--muted); font-size: 12px; line-height: 1.5; }
    .resourceActions{ margin-top: 12px; display:flex; gap: 10px; flex-wrap: wrap; }
    .resourceBtn{
      display:inline-flex; align-items:center; justify-content:center; gap: 8px;
      padding: 10px 12px; border-radius: 14px; border: 0;
      cursor:pointer; font-weight: 900; font-size: 13px; color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 26px rgba(37,99,235,.18);
      text-decoration:none;
    }

    .xbtn{
      border: 1px solid rgba(230,234,240,.9);
      background: rgba(255,255,255,.9);
      padding: 8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
    }

    .footNote{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.4; }

    @media (max-width: 1200px){
      .row6{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 980px){
      .row6{ grid-template-columns: 1fr; }
      .paramGrid{ grid-template-columns: 1fr; }
      .helpGrid{ grid-template-columns: 1fr; }
      .brandMark img{ width: min(500px, 92vw); }
      .hint{ flex-direction:column; align-items:flex-start; }
      .summaryGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Top chips -->
    <div class="topbar">
      <div class="topActions">
        <a class="topChip" href="https://enino84.github.io/" target="_blank" rel="noopener">
          üåê <span>El√≠as D Nino-Ruiz website</span>
        </a>

        <a class="topChip" href="https://aml-cs.org" target="_blank" rel="noopener">
          üß™ <span>AML-CS website</span>
        </a>

        <button class="topChip" id="openResourcesBtn" title="Educational resources">
          üìö <span>Data Assimilation Educational resources</span>
        </button>

        <button class="topChip" id="openCiteBtn" title="How to reference this tool">
          ‚ùù <span>How to reference this tool</span>
        </button>

        <button class="topChip" id="openHelpBtn" title="Method help">
          ‚ùì <span>Help</span>
        </button>
      </div>
    </div>

    <!-- Hero -->
    <div class="hero">
      <div class="brandMark">
        <img src="/static/aml-cs.jpg" alt="AML-CS logo" />
        <h1 class="mainTitle">TEDA ‚Äî Data Assimilation Benchmarking Interface</h1>
        <p class="subtitle">
          Real-time benchmarking of ensemble-based data assimilation methods
          on Lorenz-96 using the TEDA educational framework.
        </p>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <h3>Run configuration</h3>

        <label>Model</label>
        <select id="model" disabled>
          <option value="lorenz96" selected>Lorenz96 (n=40, F=8)</option>
        </select>
        <div class="muted" style="margin-top:6px;">
          Lorenz-96 defaults are fixed to the standard benchmark setting (<b>n=40</b>, <b>F=8</b>).
        </div>

        <div class="row6">
          <div>
            <label>Ensemble size</label>
            <input id="ensemble_size" type="number" value="20" min="2"/>
          </div>
          <div>
            <label>m (number of observations)</label>
            <input id="m" type="number" value="32" min="1"/>
          </div>
          <div>
            <label>std_obs (obs noise std)</label>
            <input id="std_obs" type="number" step="0.001" value="0.01" min="0"/>
          </div>
          <div>
            <label>inf_fact (inflation)</label>
            <input id="inf_fact" type="number" step="0.01" value="1.04" min="0"/>
          </div>
          <div>
            <label>obs_freq</label>
            <input id="obs_freq" type="number" step="0.01" value="0.1" min="0.001"/>
          </div>
          <div>
            <label>end_time</label>
            <input id="end_time" type="number" step="0.1" value="10" min="0.1"/>
          </div>
        </div>

        <label style="margin-top:14px;">Add method instances (chips)</label>
        <div id="methodChips" class="chipbar"></div>

        <div class="hint">
          <div class="hintLeft">
            Click a method chip to add a <b>new instance</b>.
            The same method can appear multiple times with different parameters (e.g., <b>LETKF r=1</b> vs <b>r=2</b>).
            Each instance becomes a ‚Äútablet‚Äù where parameters can be edited.
            <div class="muted" style="margin-top:6px;">
              Method tablets are <b>collapsed by default</b> (to keep the UI clean). Expand only what you need.
            </div>
          </div>
          <div class="hintRight">
            <span class="selectedPill" id="methodCountBadge">0 selected</span>
          </div>
        </div>

        <div class="methodTablets" id="methodTablets"></div>

        <div class="actionsRow">
          <button class="btn" id="runBtn">Run (streaming)</button>
          <button class="secondaryBtn" id="clearMethodsBtn" title="Remove all selected method instances">Clear methods</button>
        </div>

        <div id="status" class="muted" style="margin-top:10px;"></div>
        <div class="footNote">
          Notes: This UI is intended for quick, repeatable experiments and side-by-side comparisons.
          Downloadable CSV is generated per run for offline plotting and paper-ready figures.
        </div>
      </div>

      <div class="runs" id="runs"></div>
    </div>
  </div>

  <!-- Resources Modal -->
  <div class="modalBackdrop" id="resourcesModal">
    <div class="modal">
      <div class="modalHead">
        <strong>üìö Data Assimilation Educational resources</strong>
        <button class="xbtn" id="closeResourcesBtn">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="resourceCard">
          <h4>Free graduate course: Introduction to Data Assimilation</h4>
          <p>
            A structured, graduate-level learning path covering fundamentals of Data Assimilation:
            Bayesian foundations, sequential filtering, ensemble-based methods, and practical Python notebooks
            (Lorenz-63 / Lorenz-96 examples, uncertainty quantification, inflation and localization concepts).
          </p>
          <div class="resourceActions">
            <a class="resourceBtn" href="https://enino84.github.io/courses/intro_data_assimilation/" target="_blank" rel="noopener">
              üîó Open the course page
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Citation Modal -->
  <div class="modalBackdrop" id="citeModal">
    <div class="modal">
      <div class="modalHead">
        <strong>‚ùù How to reference this tool</strong>
        <button class="xbtn" id="closeCiteBtn">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="citeIntro">
          If you use this tool or need to reference it in your research or publication, please cite:
        </div>

        <ul class="citeList">
          <li>
            Ni√±o-Ruiz, El√≠as D., and Sebastian Racedo Valbuena.
            <i>"TEDA: A Computational Toolbox for Teaching Ensemble Based Data Assimilation."</i>
            International Conference on Computational Science. Cham: Springer International Publishing, 2022.
            ‚Äî <a href="https://link.springer.com/chapter/10.1007/978-3-031-08760-8_60" target="_blank" rel="noopener">Springer link</a>
          </li>

          <li>
            Ni√±o-Ruiz, El√≠as D.
            <i>"TEDA: A lightweight Python framework for educational data assimilation."</i>
            SoftwareX 31 (2025): 102297.
            ‚Äî <a href="https://doi.org/10.1016/j.softx.2025.102297" target="_blank" rel="noopener">DOI</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modalBackdrop" id="helpModal">
    <div class="modal">
      <div class="modalHead">
        <strong>‚ùì Method help & quick references</strong>
        <button class="xbtn" id="closeHelpBtn">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          Short method descriptions provided by the backend. Intended as quick reminders (not full documentation).
        </div>
        <div class="helpGrid" id="helpGrid"></div>
      </div>
    </div>
  </div>

<script>
/* ============================================================================
   State
============================================================================ */
let METHOD_META = null;
const selectedInstances = [];
const runState = {}; // includes charts per run

/* ============================================================================
   Utilities
============================================================================ */
function setStatus(msg){ document.getElementById("status").textContent = msg; }

function escHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function uuidShort(prefix="m"){
  const t = Date.now().toString(36);
  const r = Math.random().toString(36).slice(2,7);
  return `${prefix}-${t}-${r}`;
}

function humanLabel(name, params){
  const keys = Object.keys(params || {}).filter(k => params[k] !== "" && params[k] != null && !Number.isNaN(params[k]));
  if (!keys.length) return name;
  const bits = keys.map(k => `${k}=${params[k]}`);
  return `${name} ‚Ä¢ ${bits.join(", ")}`;
}

function updateSelectedBadge(){
  const el = document.getElementById("methodCountBadge");
  if (el) el.textContent = `${selectedInstances.length} selected`;
}

function countByMethod(){
  const m = {};
  for (const inst of selectedInstances){
    m[inst.name] = (m[inst.name] || 0) + 1;
  }
  return m;
}

/* Run status pill helper */
function setRunPill(run_id, status){
  const el = document.getElementById(`runStatus-${run_id}`);
  if (!el) return;

  el.classList.remove("ok","bad","warn");
  if (status === "running") el.classList.add("warn");
  if (status === "completed") el.classList.add("ok");
  if (status === "failed") el.classList.add("bad");

  if (status === "running"){
    el.innerHTML = `<span class="spinner"></span><span>running</span>`;
  } else if (status === "completed"){
    el.innerHTML = `<span class="checkIcon">‚úì</span><span>completed</span>`;
  } else if (status === "failed"){
    el.innerHTML = `<span>failed</span>`;
  } else {
    el.innerHTML = `<span>${escHtml(status)}</span>`;
  }
}

function statusIcon(status){
  if (status === "running") return `<span class="spinner" style="width:12px;height:12px;border-width:2px;"></span>`;
  if (status === "completed") return `<span class="checkIcon" style="width:12px;height:12px;border-radius:3px;font-size:11px;">‚úì</span>`;
  if (status === "failed") return `<span style="width:12px;height:12px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:var(--bad);">!</span>`;
  return `<span style="width:12px;height:12px;display:inline-block;"></span>`;
}

/* ============================================================================
   Color helpers (deterministic per method label)
   - Used for polar colors ‚Äúper method‚Äù
============================================================================ */
function hashStrToHue(str){
  let h = 0;
  for (let i=0;i<str.length;i++){
    h = (h * 31 + str.charCodeAt(i)) >>> 0;
  }
  return h % 360;
}
function rgbaFromHue(h, a){
  // HSL-ish via CSS: we'll output as hsla so Chart.js can use it directly
  return `hsla(${h}, 75%, 55%, ${a})`;
}
function borderFromHue(h){
  return `hsla(${h}, 75%, 40%, 1)`;
}

/* ============================================================================
   Load methods + render chips + help
============================================================================ */
async function loadMethods(){
  const res = await fetch("/api/methods");
  METHOD_META = await res.json();

  renderMethodChips();
  renderHelpModal();
  updateSelectedBadge();

  // sensible default demo
  if (selectedInstances.length === 0){
    if (METHOD_META.methods.includes("letkf")){
      addMethodInstance("letkf");
      addMethodInstance("letkf");
      const inst2 = selectedInstances[1];
      if (inst2 && inst2.params && Object.prototype.hasOwnProperty.call(inst2.params, "r")){
        inst2.params.r = 2;
        inst2.label = humanLabel(inst2.name, inst2.params);
      }
    } else if (METHOD_META.methods.length){
      addMethodInstance(METHOD_META.methods[0]);
    }
    renderMethodTablets();
    renderMethodChips(); // refresh selected styling + counts
  }
}

function renderMethodChips(){
  const chips = document.getElementById("methodChips");
  chips.innerHTML = "";

  const counts = countByMethod();

  METHOD_META.methods.forEach(name => {
    const chip = document.createElement("div");
    const isSelected = (counts[name] || 0) > 0;

    chip.className = "methodChip" + (isSelected ? " selected" : "");
    chip.innerHTML = `
      <span class="dot"></span>
      <span>${escHtml(name)}</span>
      <span class="chipCount">${counts[name] || 0}</span>
    `;

    chip.addEventListener("click", () => {
      addMethodInstance(name);
      renderMethodTablets();
      renderMethodChips(); // update chip colors after selecting
    });

    chips.appendChild(chip);
  });
}

function renderHelpModal(){
  const grid = document.getElementById("helpGrid");
  grid.innerHTML = "";
  const help = METHOD_META.help || {};

  METHOD_META.methods.forEach(name => {
    const card = document.createElement("div");
    card.className = "helpCard";
    const text = help[name] || "No help text available yet.";
    card.innerHTML = `<strong>${escHtml(name)}</strong><p>${escHtml(text)}</p>`;
    grid.appendChild(card);
  });
}

/* ============================================================================
   Method instances
============================================================================ */
function addMethodInstance(name){
  const defaults = (METHOD_META.defaults && METHOD_META.defaults[name])
    ? structuredClone(METHOD_META.defaults[name])
    : {};

  const id = uuidShort("mid");
  const params = defaults || {};
  const label = humanLabel(name, params);

  selectedInstances.push({ id, name, label, params });
  updateSelectedBadge();
}

function removeMethodInstance(id){
  const idx = selectedInstances.findIndex(x => x.id === id);
  if (idx >= 0) selectedInstances.splice(idx, 1);
  updateSelectedBadge();
}

function moveInstance(id, dir){
  const idx = selectedInstances.findIndex(x => x.id === id);
  if (idx < 0) return;
  const j = idx + dir;
  if (j < 0 || j >= selectedInstances.length) return;
  const tmp = selectedInstances[idx];
  selectedInstances[idx] = selectedInstances[j];
  selectedInstances[j] = tmp;
}

function renderMethodTablets(){
  const wrap = document.getElementById("methodTablets");
  wrap.innerHTML = "";

  if (selectedInstances.length === 0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.marginTop = "8px";
    empty.textContent = "No methods selected yet. Add one using the chips above.";
    wrap.appendChild(empty);
    return;
  }

  selectedInstances.forEach((inst, index) => {
    const tablet = document.createElement("div");
    tablet.className = "tablet";
    tablet.id = `tablet-${inst.id}`;

    const head = document.createElement("div");
    head.className = "tabletHead";

    const left = document.createElement("div");
    left.className = "tabletLeft";
    left.innerHTML = `
      <div class="dot ok"></div>
      <div class="tabletTitle">
        <strong>${escHtml(inst.label)}</strong>
        <span>ID: ${escHtml(inst.id)} ‚Ä¢ ${escHtml(inst.name)}</span>
      </div>
    `;

    const right = document.createElement("div");
    right.className = "tabletRight";
    right.innerHTML = `
      <button class="miniBtn" title="Move up" ${index===0 ? "disabled" : ""} data-act="up">‚Üë</button>
      <button class="miniBtn" title="Move down" ${index===selectedInstances.length-1 ? "disabled" : ""} data-act="down">‚Üì</button>
      <button class="miniBtn" title="Remove" data-act="rm">Remove</button>
      <span style="margin-left:6px;" data-arrow>‚ñº</span>
    `;

    head.appendChild(left);
    head.appendChild(right);

    const body = document.createElement("div");
    body.className = "tabletBody";   // collapsed by default

    const schema = (METHOD_META.schema && METHOD_META.schema[inst.name]) ? METHOD_META.schema[inst.name] : {};
    body.appendChild(renderParamForm(inst, schema));

    head.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (btn) return;
      const open = body.classList.toggle("open");
      right.querySelector("[data-arrow]").textContent = open ? "‚ñ≤" : "‚ñº";
    });

    right.addEventListener("click", (e) => {
      const b = e.target.closest("button");
      if (!b) return;
      const act = b.getAttribute("data-act");
      if (act === "rm"){
        removeMethodInstance(inst.id);
        renderMethodTablets();
        renderMethodChips();
      }
      if (act === "up"){
        moveInstance(inst.id, -1);
        renderMethodTablets();
      }
      if (act === "down"){
        moveInstance(inst.id, +1);
        renderMethodTablets();
      }
    });

    tablet.appendChild(head);
    tablet.appendChild(body);
    wrap.appendChild(tablet);
  });
}

function renderParamForm(inst, schema){
  const container = document.createElement("div");

  const keys = Object.keys(schema || {});
  if (keys.length === 0){
    const p = document.createElement("div");
    p.className = "muted";
    p.textContent = "No tunable parameters detected for this method.";
    container.appendChild(p);
    return container;
  }

  const grid = document.createElement("div");
  grid.className = "paramGrid";

  keys.forEach(k => {
    const spec = schema[k] || { type:"str", label:k };

    const field = document.createElement("div");
    field.className = "paramField";
    const lab = document.createElement("label");
    lab.textContent = spec.label || k;

    let input;

    if (spec.type === "bool"){
      input = document.createElement("select");
      input.innerHTML = `<option value="true">true</option><option value="false">false</option>`;
      input.value = String(!!inst.params[k]);
      input.addEventListener("change", () => {
        inst.params[k] = (input.value === "true");
        inst.label = humanLabel(inst.name, inst.params);
        document.querySelector(`#tablet-${inst.id} .tabletTitle strong`).textContent = inst.label;
        renderMethodChips();
      });
    } else {
      input = document.createElement("input");
      input.type = (spec.type === "int" || spec.type === "float") ? "number" : "text";
      if (spec.type === "float") input.step = spec.step ?? "0.01";
      if (spec.type === "int") input.step = spec.step ?? "1";
      if (spec.min != null) input.min = String(spec.min);

      const v = inst.params[k];
      input.value = (v === undefined || v === null) ? "" : String(v);

      input.addEventListener("input", () => {
        const raw = input.value;
        if (spec.type === "int") inst.params[k] = raw === "" ? "" : parseInt(raw, 10);
        else if (spec.type === "float") inst.params[k] = raw === "" ? "" : parseFloat(raw);
        else inst.params[k] = raw;

        inst.label = humanLabel(inst.name, inst.params);
        document.querySelector(`#tablet-${inst.id} .tabletTitle strong`).textContent = inst.label;
        renderMethodChips();
      });
    }

    field.appendChild(lab);
    field.appendChild(input);
    grid.appendChild(field);
  });

  container.appendChild(grid);

  const tip = document.createElement("div");
  tip.className = "muted";
  tip.style.marginTop = "8px";
  tip.textContent = "Tip: labels update automatically based on parameters.";
  container.appendChild(tip);

  return container;
}

/* ============================================================================
   Runs UI + charts + SSE
============================================================================ */
function createRunCard(run_id, model){
  const runs = document.getElementById("runs");

  const card = document.createElement("div");
  card.className = "runCard";
  card.id = `run-${run_id}`;

  const head = document.createElement("div");
  head.className = "runHead";

  const left = document.createElement("div");
  left.className = "runTitle";
  left.innerHTML = `<strong>Run ${run_id.slice(0,8)} ‚Ä¢ ${model}</strong>
                    <span id="runSub-${run_id}">Queued‚Ä¶</span>`;

  const right = document.createElement("div");
  right.className = "right";
  right.innerHTML = `
    <a class="miniBtn" href="/api/runs/${run_id}/csv" style="text-decoration:none;" title="Download CSV">
      Download CSV
    </a>
    <span class="pill" id="runStatus-${run_id}"><span>queued</span></span>
    <span data-arrow>‚ñº</span>
  `;

  head.appendChild(left);
  head.appendChild(right);

  const body = document.createElement("div");
  body.className = "runBody";

  const toolbar = document.createElement("div");
  toolbar.className = "toolbar";
  toolbar.innerHTML = `
    <div class="chipbar" id="runChips-${run_id}"></div>
    <div class="toggle">
      <span>Scale</span>
      <button id="lin-${run_id}">Linear</button>
      <button id="log-${run_id}" class="active">Log</button>
    </div>
  `;

  // SECTION: Time series chart (open by default)
  const secChart = document.createElement("div");
  secChart.className = "section";
  secChart.innerHTML = `
    <div class="sectionHead" data-sec="chart">
      <strong>Chart</strong>
      <div class="sectionRight">
        <span class="muted">Streaming updates</span>
        <span data-arrow>‚ñ≤</span>
      </div>
    </div>
    <div class="sectionBody open" id="secChartBody-${run_id}">
      <div class="chartWrap">
        <canvas id="chart-${run_id}"></canvas>
      </div>
    </div>
  `;

  // SECTION: Metrics (collapsed by default) ‚Äî includes SUMMARY (radar + polar) + table
  const secTable = document.createElement("div");
  secTable.className = "section";
  secTable.innerHTML = `
    <div class="sectionHead" data-sec="table">
      <strong>Metrics</strong>
      <div class="sectionRight">
        <span class="muted">RMSE + summary</span>
        <span data-arrow>‚ñº</span>
      </div>
    </div>
    <div class="sectionBody" id="secTableBody-${run_id}">
      <div class="summaryGrid">
        <div class="chartWrap">
          <div class="summaryTitle">
            <span>RMSE by method (Background vs Analysis)</span>
            <span class="muted">radar</span>
          </div>
          <canvas id="rmseRadar-${run_id}"></canvas>
        </div>

        <div class="chartWrap">
          <div class="summaryTitle">
            <span>RMSE improvement (%)</span>
            <span class="muted">polar</span>
          </div>
          <canvas id="rmsePolar-${run_id}"></canvas>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Method</th>
            <th>Status</th>
            <th>RMSE (analysis)</th>
            <th>RMSE (background)</th>
            <th>Final</th>
            <th>Mean</th>
            <th>Min</th>
            <th>Runtime (s)</th>
            <th>Params</th>
          </tr>
        </thead>
        <tbody id="tbl-${run_id}"></tbody>
      </table>
    </div>
  `;

  body.appendChild(toolbar);
  body.appendChild(secChart);
  body.appendChild(secTable);

  head.addEventListener("click", (e) => {
    if (e.target.closest("a")) return;
    const open = body.classList.toggle("open");
    right.querySelector("[data-arrow]").textContent = open ? "‚ñ≤" : "‚ñº";
  });

  // toggle sections
  secChart.querySelector(".sectionHead").addEventListener("click", () => {
    const b = document.getElementById(`secChartBody-${run_id}`);
    const arrow = secChart.querySelector(".sectionHead [data-arrow]");
    const open = b.classList.toggle("open");
    arrow.textContent = open ? "‚ñ≤" : "‚ñº";
    if (open) redraw(run_id);
  });

  secTable.querySelector(".sectionHead").addEventListener("click", () => {
    const b = document.getElementById(`secTableBody-${run_id}`);
    const arrow = secTable.querySelector(".sectionHead [data-arrow]");
    const open = b.classList.toggle("open");
    arrow.textContent = open ? "‚ñ≤" : "‚ñº";
    if (open){
      ensureSummaryCharts(run_id);
      updateSummaryCharts(run_id);
    }
  });

  card.appendChild(head);
  card.appendChild(body);
  runs.prepend(card);

  runState[run_id] = {
    chart: null,               // time-series
    rmseRadar: null,           // radar summary
    rmsePolar: null,           // polar summary
    scaleMode: "log",
    instancesById: {},
    seriesA: {},
    statuses: {},
    metrics: {},
    runtime: {},
    lastDraw: 0
  };

  document.getElementById(`lin-${run_id}`).addEventListener("click", () => setScale(run_id, "linear"));
  document.getElementById(`log-${run_id}`).addEventListener("click", () => setScale(run_id, "log"));

  openRunCard(run_id);
  setScale(run_id, "log"); // default log scale
}

function openRunCard(run_id){
  document.querySelectorAll(".runBody.open").forEach(el => el.classList.remove("open"));
  document.querySelectorAll(".runHead .right [data-arrow]").forEach(a => a.textContent = "‚ñº");

  const body = document.querySelector(`#run-${run_id} .runBody`);
  const arrow = document.querySelector(`#run-${run_id} .runHead .right [data-arrow]`);
  if (body) body.classList.add("open");
  if (arrow) arrow.textContent = "‚ñ≤";
}

function setScale(run_id, mode){
  runState[run_id].scaleMode = mode;
  document.getElementById(`lin-${run_id}`).classList.toggle("active", mode === "linear");
  document.getElementById(`log-${run_id}`).classList.toggle("active", mode === "log");
  redraw(run_id);
}

function ensureChart(run_id){
  const st = runState[run_id];
  if (st.chart) return;

  const ctx = document.getElementById(`chart-${run_id}`).getContext("2d");

  st.chart = new Chart(ctx, {
    type: "line",
    data: { datasets: [] },
    options: {
      responsive: true,
      animation: false,
      parsing: false,
      scales: {
        x: { type: "linear", title: { display: true, text: "t" } },
        y: { type: "logarithmic", title: { display: true, text: "relative error" } }
      },
      plugins: { legend: { display: true } }
    }
  });
}

function redraw(run_id){
  ensureChart(run_id);
  const st = runState[run_id];

  st.chart.options.scales.y.type = (st.scaleMode === "log") ? "logarithmic" : "linear";

  const datasets = [];
  for (const method_id of Object.keys(st.seriesA)){
    const pts = st.seriesA[method_id] || [];
    const meta = st.instancesById[method_id] || {};
    const label = meta.label || method_id;

    datasets.push({
      label: `${label} (analysis)`,
      data: pts,
      borderWidth: 2,
      pointRadius: 0
    });
  }

  st.chart.data.datasets = datasets;
  st.chart.update();
}

/* ====== Summary charts (radar + polar) ====== */
function ensureSummaryCharts(run_id){
  const st = runState[run_id];

  if (!st.rmseRadar){
    const ctxR = document.getElementById(`rmseRadar-${run_id}`).getContext("2d");
    st.rmseRadar = new Chart(ctxR, {
      type: "radar",
      data: {
        labels: [],
        datasets: [
          { label: "RMSE background", data: [], fill: true, pointRadius: 2 },
          { label: "RMSE analysis", data: [], fill: true, pointRadius: 2 }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: { legend: { display: true } },
        scales: {
          r: {
            beginAtZero: true,
            ticks: { callback: (v) => v }
          }
        }
      }
    });
  }

  if (!st.rmsePolar){
    const ctxP = document.getElementById(`rmsePolar-${run_id}`).getContext("2d");
    st.rmsePolar = new Chart(ctxP, {
      type: "polarArea",
      data: { labels: [], datasets: [{ label: "Improvement (%)", data: [], backgroundColor: [], borderColor: [], borderWidth: 1 }] },
      options: {
        responsive: true,
        animation: false,
        plugins: { legend: { display: true } },
        scales: {
          r: { suggestedMin: 0, suggestedMax: 100, ticks: { callback: (v) => v + "%" } }
        }
      }
    });
  }
}

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

function updateSummaryCharts(run_id){
  const st = runState[run_id];
  if (!st.rmseRadar || !st.rmsePolar) return;

  const ids = Object.keys(st.instancesById);
  const labels = [];
  const rmseB = [];
  const rmseA = [];

  for (const id of ids){
    const meta = st.instancesById[id] || {};
    const m = st.metrics[id] || {};
    const a = safeNum(m.rmse_a);
    const b = safeNum(m.rmse_b);

    if (a == null && b == null) continue;

    labels.push(meta.label || meta.name || id.slice(0,6));
    rmseA.push(a ?? null);
    rmseB.push(b ?? null);
  }

  // Radar (background vs analysis)
  st.rmseRadar.data.labels = labels;
  st.rmseRadar.data.datasets[0].data = rmseB.map(v => v ?? null);
  st.rmseRadar.data.datasets[1].data = rmseA.map(v => v ?? null);
  st.rmseRadar.update();

  // Polar: improvement (%) per method + color per method
  const perc = [];
  const bgColors = [];
  const brColors = [];

  const validA = rmseA.filter(v => v != null);
  const maxA = validA.length ? Math.max(...validA) : null;

  for (let i=0; i<labels.length; i++){
    const a = rmseA[i];
    const b = rmseB[i];

    let p = 0;
    if (a != null && b != null && b > 0){
      p = (1 - (a / b)) * 100;
    } else if (a != null && maxA != null && maxA > 0){
      p = (1 - (a / maxA)) * 100;
    }
    p = clamp(p, 0, 100);
    perc.push(p);

    const hue = hashStrToHue(labels[i]);
    bgColors.push(rgbaFromHue(hue, 0.55));
    brColors.push(borderFromHue(hue));
  }

  st.rmsePolar.data.labels = labels;
  st.rmsePolar.data.datasets[0].data = perc;
  st.rmsePolar.data.datasets[0].backgroundColor = bgColors;
  st.rmsePolar.data.datasets[0].borderColor = brColors;
  st.rmsePolar.update();
}

/* ====== Run chips + table ====== */
function renderRunChips(run_id){
  const chipWrap = document.getElementById(`runChips-${run_id}`);
  chipWrap.innerHTML = "";

  const st = runState[run_id];

  Object.keys(st.instancesById).forEach(method_id => {
    const meta = st.instancesById[method_id];
    const status = st.statuses[method_id] || "queued";

    let dotClass = "";
    if (status === "completed") dotClass = "ok";
    else if (status === "failed") dotClass = "bad";
    else if (status === "running") dotClass = "warn";

    const chip = document.createElement("div");
    chip.className = "runChip";
    chip.innerHTML = `
      <span class="dot ${dotClass}"></span>
      ${statusIcon(status)}
      <span>${escHtml(meta.label || meta.name || method_id)}</span>
      <span style="color:#64748b;">${escHtml(status)}</span>
    `;
    chipWrap.appendChild(chip);
  });
}

function fmtNum(x, digits=6){
  if (x === null || x === undefined) return "";
  const n = Number(x);
  if (!Number.isFinite(n)) return "";
  return n.toFixed(digits);
}

function updateTable(run_id){
  const st = runState[run_id];
  const tbody = document.getElementById(`tbl-${run_id}`);
  tbody.innerHTML = "";

  Object.keys(st.instancesById).forEach(method_id => {
    const meta = st.instancesById[method_id] || {};
    const status = st.statuses[method_id] || "queued";
    const metrics = st.metrics[method_id] || {};
    const rt = st.runtime[method_id];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escHtml(meta.label || meta.name || method_id)}</strong><br/><small>${escHtml(method_id)}</small></td>
      <td>${escHtml(status)}</td>
      <td>${fmtNum(metrics.rmse_a, 6)}</td>
      <td>${fmtNum(metrics.rmse_b, 6)}</td>
      <td>${fmtNum(metrics.final, 6)}</td>
      <td>${fmtNum(metrics.mean, 6)}</td>
      <td>${fmtNum(metrics.min, 6)}</td>
      <td>${rt != null ? Number(rt).toFixed(3) : ""}</td>
      <td><small>${escHtml(JSON.stringify(meta.params || {}))}</small></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================================
   Run creation + SSE
============================================================================ */
async function createRun(){
  if (!METHOD_META){
    setStatus("Methods metadata not loaded yet.");
    return;
  }

  if (selectedInstances.length === 0){
    setStatus("Please add at least one method instance.");
    return;
  }

  const methods = selectedInstances.map(inst => {
    const cleaned = {};
    for (const k of Object.keys(inst.params || {})){
      const v = inst.params[k];
      if (v === "" || v === null || Number.isNaN(v)) continue;
      cleaned[k] = v;
    }
    return {
      id: inst.id,
      name: inst.name,
      label: inst.label,
      params: cleaned
    };
  });

  const payload = {
    model: "lorenz96",
    ensemble_size: parseInt(document.getElementById("ensemble_size").value, 10),
    m: parseInt(document.getElementById("m").value, 10),
    std_obs: parseFloat(document.getElementById("std_obs").value),
    obs_freq: parseFloat(document.getElementById("obs_freq").value),
    end_time: parseFloat(document.getElementById("end_time").value),
    inf_fact: parseFloat(document.getElementById("inf_fact").value),
    methods
  };

  setStatus("Creating run‚Ä¶");

  const res = await fetch("/api/runs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (!res.ok){
    setStatus("Error: " + (data.error || "unknown"));
    return;
  }

  const run_id = data.run_id;
  createRunCard(run_id, payload.model);

  const st = runState[run_id];
  methods.forEach(m => {
    st.instancesById[m.id] = { name: m.name, label: m.label, params: m.params };
    st.statuses[m.id] = "queued";
    st.seriesA[m.id] = [];
  });

  renderRunChips(run_id);
  updateTable(run_id);
  redraw(run_id);

  // summary charts exist but metrics section is closed by default
  ensureSummaryCharts(run_id);
  updateSummaryCharts(run_id);

  setStatus(`Run created: ${run_id.slice(0,8)} (streaming‚Ä¶)`);

  const es = new EventSource(`/api/runs/${run_id}/events`);

  es.addEventListener("run_started", () => {
    setRunPill(run_id, "running");
    document.getElementById(`runSub-${run_id}`).textContent = "Running‚Ä¶";
  });

  es.addEventListener("method_started", (ev) => {
    const d = JSON.parse(ev.data);
    st.statuses[d.method_id] = "running";
    st.instancesById[d.method_id] = st.instancesById[d.method_id] || { name: d.name, label: d.label, params: d.params };
    renderRunChips(run_id);
    updateTable(run_id);
    updateSummaryCharts(run_id);
  });

  es.addEventListener("partial", (ev) => {
    const d = JSON.parse(ev.data);
    const method_id = d.method_id;

    if (!st.seriesA[method_id]) st.seriesA[method_id] = [];
    st.seriesA[method_id].push({ x: d.t, y: d.error_a });

    const now = performance.now();
    if (now - st.lastDraw > 220){
      st.lastDraw = now;
      redraw(run_id);
    }
  });

  es.addEventListener("method_completed", (ev) => {
    const d = JSON.parse(ev.data);
    st.statuses[d.method_id] = "completed";
    st.metrics[d.method_id] = d.metrics || {};
    st.runtime[d.method_id] = d.runtime_sec;

    renderRunChips(run_id);
    updateTable(run_id);
    redraw(run_id);

    updateSummaryCharts(run_id);
  });

  es.addEventListener("run_completed", () => {
    setRunPill(run_id, "completed");
    document.getElementById(`runSub-${run_id}`).textContent = "Completed";
    renderRunChips(run_id);
    updateTable(run_id);
    redraw(run_id);
    updateSummaryCharts(run_id);
    es.close();
  });

  es.addEventListener("run_failed", (ev) => {
    const d = JSON.parse(ev.data);
    setRunPill(run_id, "failed");
    document.getElementById(`runSub-${run_id}`).textContent = "Failed: " + d.error;
    es.close();
  });

  setRunPill(run_id, "queued");
}

/* ============================================================================
   Modals
============================================================================ */
const helpModal = document.getElementById("helpModal");
document.getElementById("openHelpBtn").addEventListener("click", () => helpModal.classList.add("open"));
document.getElementById("closeHelpBtn").addEventListener("click", () => helpModal.classList.remove("open"));
helpModal.addEventListener("click", (e) => { if (e.target === helpModal) helpModal.classList.remove("open"); });

const citeModal = document.getElementById("citeModal");
document.getElementById("openCiteBtn").addEventListener("click", () => citeModal.classList.add("open"));
document.getElementById("closeCiteBtn").addEventListener("click", () => citeModal.classList.remove("open"));
citeModal.addEventListener("click", (e) => { if (e.target === citeModal) citeModal.classList.remove("open"); });

const resourcesModal = document.getElementById("resourcesModal");
document.getElementById("openResourcesBtn").addEventListener("click", () => resourcesModal.classList.add("open"));
document.getElementById("closeResourcesBtn").addEventListener("click", () => resourcesModal.classList.remove("open"));
resourcesModal.addEventListener("click", (e) => { if (e.target === resourcesModal) resourcesModal.classList.remove("open"); });

/* ============================================================================
   Buttons
============================================================================ */
document.getElementById("runBtn").addEventListener("click", () => createRun());

document.getElementById("clearMethodsBtn").addEventListener("click", () => {
  selectedInstances.splice(0, selectedInstances.length);
  updateSelectedBadge();
  renderMethodTablets();
  renderMethodChips();
  setStatus("Cleared method instances.");
});

/* ============================================================================
   Init
============================================================================ */
loadMethods();
</script>
</body>
</html>
